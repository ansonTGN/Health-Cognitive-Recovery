<script>
    // Colores y Configuración
    const COLORS = { Person:'#1565c0', Condition:'#c62828', Intervention:'#2e7d32', Outcome:'#6a1b9a', CommunityResource:'#00838f', Concept:'#455a64', Unknown:'#9e9e9e' };
    const ICONS = { Person:'\uf007', Condition:'\uf4fd', Intervention:'\uf0f0', Outcome:'\uf201', CommunityResource:'\uf4c4', Concept:'\uf0eb', Unknown:'\uf128' };
    let network, allNodesData, allEdgesData, currentFocusNode = null;
    let lastChatSources = [];
    const currentUser = "{{ username }}";

    document.addEventListener('DOMContentLoaded', () => { 
        loadGraph();
        // Si el elemento userList existe (es admin), cargamos usuarios
        if(document.getElementById('userList')) loadUsers();
    });

    // ---------------------------------------------------------
    // 1. LOGICA DE GRAFO Y FICHA
    // ---------------------------------------------------------
    async function loadGraph() {
        document.getElementById('loading').style.display='flex';
        try {
            const res = await fetch('/api/graph');
            if (res.status === 401) return window.location.href = "/";
            const data = await res.json();
            
            const nodes = data.nodes.map(n => ({
                id: n.id, label: n.label.length>15?n.label.substring(0,14)+'..':n.label, fullLabel: n.label, group: n.group,
                shape:'icon', icon:{ face:'"Font Awesome 6 Free"', code:ICONS[n.group]||'\uf128', weight:'900', size:35, color:COLORS[n.group]||'#999' },
                font:{face:'Manrope', size:12, color:'#333', background:'rgba(255,255,255,0.9)'}
            }));
            const edges = data.edges.map(e => ({ from:e.from, to:e.to, label: e.label.replace(/_/g, ' ').toLowerCase(), color:{color:'#cfd8dc'}, arrows:'to', font: {align:'middle', size:10, color:'#aaa'} }));
            
            allNodesData = new vis.DataSet(nodes); 
            allEdgesData = new vis.DataSet(edges);
            network = new vis.Network(document.getElementById('network-container'), { nodes:allNodesData, edges:allEdgesData }, {
                nodes: { borderWidth: 0, shadow:true },
                physics: { stabilization: false, barnesHut: { gravitationalConstant: -3000, springConstant: 0.04 } }
            });
            network.on("click", p => { if(p.nodes.length) showDetails(p.nodes[0]); });

        } catch(e) { console.error(e); } finally { document.getElementById('loading').style.display='none'; }
    }

    function showDetails(id) {
        currentFocusNode = id;
        const n = allNodesData.get(id);
        if(!n) return;

        // 1. Activar pestaña visualmente (Bootstrap 5)
        const triggerEl = document.querySelector('#tab-btn-details');
        const tabInstance = bootstrap.Tab.getOrCreateInstance(triggerEl);
        tabInstance.show();

        // 2. Mostrar contenido
        document.getElementById('details-empty').classList.add('d-none');
        document.getElementById('details-content').classList.remove('d-none');
        
        // 3. Rellenar datos
        document.getElementById('detail-title').innerText = n.fullLabel || n.label;
        document.getElementById('detail-id-short').innerText = id.substring(0,8);
        const badge = document.getElementById('detail-badge');
        badge.innerText = n.group; badge.style.backgroundColor = COLORS[n.group] || '#999';

        const rels = allEdgesData.get({ filter: e => e.from === id || e.to === id });
        document.getElementById('detail-degree').innerText = rels.length;
        document.getElementById('detail-pagerank').innerText = rels.length > 5 ? 'ALTA' : 'MEDIA';

        // 4. Lista de relaciones
        const list = document.getElementById('detail-connections-list');
        list.innerHTML = rels.length ? rels.map(e => {
            const isOut = e.from === id;
            const otherId = isOut ? e.to : e.from;
            const other = allNodesData.get(otherId);
            return `<div class="p-2 border rounded bg-light mb-1 d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="focusOnNode('${otherId}')">
                <span class="badge bg-white text-dark border">${e.label}</span>
                <span class="text-truncate ms-2 fw-bold" style="max-width: 120px;">${other?other.fullLabel:otherId}</span>
            </div>`;
        }).join('') : '<div class="text-muted text-center p-2">Sin conexiones</div>';
        
        // Movil
        if(window.innerWidth < 992) document.body.classList.add('sidebar-open');
    }

    function clearDetails() {
        document.getElementById('details-content').classList.add('d-none');
        document.getElementById('details-empty').classList.remove('d-none');
        currentFocusNode = null; network.unselectAll();
    }

    function focusOnNode(id) { network.selectNodes([id]); network.focus(id, {scale: 1.2, animation: true}); showDetails(id); }
    function focusOnNodeContext() { if(!currentFocusNode) return; const all = [currentFocusNode, ...network.getConnectedNodes(currentFocusNode)]; network.fit({ nodes: all, animation: true }); }

    // ---------------------------------------------------------
    // 2. CHAT & FUENTES
    // ---------------------------------------------------------
    async function sendChat() {
        const input = document.getElementById('userPrompt');
        const txt = input.value.trim(); if(!txt) return;
        const chatArea = document.getElementById('chatArea'); 
        
        // User Msg
        chatArea.innerHTML += `<div class="msg-bubble msg-user animate__animated animate__fadeInUp">${txt}</div>`;
        input.value = ''; chatArea.scrollTop = chatArea.scrollHeight;

        // Loader
        const loaderId = 'loader-'+Date.now();
        chatArea.innerHTML += `<div id="${loaderId}" class="msg-bubble msg-ai text-muted"><i class="fa-solid fa-circle-notch fa-spin me-2"></i> Procesando...</div>`;

        try {
            const res = await fetch('/api/chat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:txt})});
            const data = await res.json();
            document.getElementById(loaderId).remove();

            if (!res.ok) throw new Error(data.error || "Error en respuesta");

            lastChatSources = data.sources || [];
            
            // Renderizar Markdown
            let htmlContent = marked.parse(data.response);
            
            // Reemplazar [1] por badges
            htmlContent = htmlContent.replace(/\[(\d+)\]/g, (match, idx) => {
                return `<span class="badge bg-primary citation-badge" onclick="visualizeSource(${idx})">${idx}</span>`;
            });

            // Generar Tarjetas de Fuentes
            let sourcesHtml = '';
            if (lastChatSources.length > 0) {
                sourcesHtml = '<div class="mt-3 pt-2 border-top"><small class="text-muted fw-bold text-uppercase">FUENTES:</small>';
                sourcesHtml += lastChatSources.map(s => `
                    <div class="source-card" onclick="visualizeSource(${s.index})">
                        <div class="d-flex justify-content-between mb-1">
                            <strong class="text-primary">Fuente [${s.index}]</strong>
                            <i class="fa-solid fa-eye text-muted"></i>
                        </div>
                        <div class="text-truncate fst-italic text-dark">"${s.short_content}"</div>
                    </div>
                `).join('');
                sourcesHtml += '</div>';
            }

            chatArea.innerHTML += `<div class="msg-bubble msg-ai animate__animated animate__fadeIn"><div>${htmlContent}</div>${sourcesHtml}</div>`;

        } catch(e) { 
            document.getElementById(loaderId)?.remove();
            chatArea.innerHTML += `<div class="alert alert-danger small p-2">Error: ${e.message}</div>`; 
        }
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function visualizeSource(index) {
        const source = lastChatSources.find(s => s.index == index);
        if(!source) return alert("Fuente no encontrada");
        
        const ids = source.concepts.filter(id => allNodesData.get(id));
        if(!ids.length) return alert("Conceptos no visibles en el grafo actual");

        network.unselectAll();
        network.selectNodes(ids);
        network.fit({ nodes: ids, animation: true });
        if(ids.length === 1) showDetails(ids[0]);
    }

    // ---------------------------------------------------------
    // 3. ADMIN: USUARIOS
    // ---------------------------------------------------------
    async function loadUsers() {
        const list = document.getElementById('userList');
        if(!list) return;
        try {
            const res = await fetch('/api/admin/users');
            if(!res.ok) throw new Error("Sin permisos");
            const users = await res.json();
            list.innerHTML = users.map(u => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">${u.username}</span> 
                        <span class="badge bg-light text-dark border ms-2">${u.role}</span>
                    </div>
                    ${u.username !== currentUser ? `<button onclick="deleteUser('${u.username}')" class="btn btn-sm text-danger"><i class="fa-solid fa-trash"></i></button>` : '<small class="text-muted">Tú</small>'}
                </li>`).join('');
        } catch(e) { list.innerHTML = `<li class="list-group-item text-danger text-center small">${e.message}</li>`; }
    }

    async function createUser(e) {
        e.preventDefault();
        try {
            const res = await fetch('/api/admin/users', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({
                    username:document.getElementById('newUsername').value,
                    password:document.getElementById('newPassword').value,
                    role:document.getElementById('newRole').value
                })
            });
            if(res.ok) { alert("Usuario creado"); loadUsers(); document.getElementById('newUsername').value=''; document.getElementById('newPassword').value=''; }
            else { alert("Error al crear usuario"); }
        } catch(e) { alert("Error de red"); }
    }

    async function deleteUser(u) {
        if(confirm(`¿Borrar a ${u}?`)) {
            await fetch(`/api/admin/users/${u}`, {method:'DELETE'});
            loadUsers();
        }
    }

    // ---------------------------------------------------------
    // 4. UTILS & INGEST
    // ---------------------------------------------------------
    function toggleSidebar() { document.body.classList.toggle('sidebar-open'); }
    function handleEnter(e) { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }}
    function exportCanvasImage() { 
        const link = document.createElement('a'); link.download = 'grafo.png'; 
        link.href = document.querySelector('#network-container canvas').toDataURL(); link.click(); 
    }
    function downloadGraph(fmt) { window.open(`/api/export?format=${fmt}`, '_blank'); }
    
    async function startIngestion() {
        const fd = new FormData();
        const txt = document.getElementById('ingestContent').value;
        const file = document.getElementById('ingestFile').files[0];
        if(!txt && !file) return alert("Ingresa texto o archivo");
        
        if(txt) fd.append('content', txt);
        if(file) fd.append('file', file);

        document.getElementById('progressArea').classList.remove('d-none');
        document.getElementById('progressArea').innerHTML = '<div class="text-warning">Iniciando subida...</div>';

        const res = await fetch('/api/ingest', {method:'POST', body:fd});
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        
        while(true) {
            const {done, value} = await reader.read();
            if(done) break;
            const text = decoder.decode(value);
            document.getElementById('progressArea').innerHTML += `<div>${text}</div>`;
            document.getElementById('progressArea').scrollTop = document.getElementById('progressArea').scrollHeight;
        }
        loadGraph();
    }
    
    async function runReasoning() {
        const res = await fetch('/api/reasoning/run', {method:'POST'});
        const data = await res.json();
        document.getElementById('reasoningResult').innerText = `✅ ${data.length} nuevas relaciones inferidas`;
        loadGraph();
    }
</script>
